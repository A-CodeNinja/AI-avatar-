# AI头像生成小程序 - 云开发部署指南

## 一、云开发环境配置

### 1.1 开通云开发
1. 打开微信开发者工具，导入项目
2. 点击顶部工具栏的 **"云开发"** 按钮
3. 点击 **"开通"** 按钮
4. 选择 **"按量付费"** 或 **"免费版"**（推荐免费版用于测试）
5. 填写环境名称，点击 **"确定"**
6. 等待环境创建完成（约1-2分钟）

### 1.2 获取环境ID
1. 在云开发控制台，点击 **"设置"** → **"环境设置"**
2. 复制 **环境ID**（格式类似：`cloud1-xxx`）
3. 在 `miniprogram/app.js` 中配置：

```javascript
App({
  onLaunch: function () {
    this.globalData = {
      env: "你的环境ID",  // 这里填入你的环境ID
    };
    // ...
  },
});
```

---

## 二、数据库部署

### 2.1 创建数据库集合
在云开发控制台 → **数据库** 中，创建以下3个集合：

#### 集合1：users（用户表）
- 集合名称：`users`
- 权限设置：**仅创建者可读写**

#### 集合2：images（图片表）
- 集合名称：`images`
- 权限设置：**仅创建者可读写**

#### 集合3：points_log（积分日志表）
- 集合名称：`points_log`
- 权限设置：**仅创建者可读写**

### 2.2 数据库权限配置
每个集合的权限建议设置为：
- **所有用户可读，仅创建者可写**（更安全）
- 或 **仅创建者可读写**（最严格）

---

## 三、云函数部署

### 3.1 云函数列表
项目包含以下云函数：
1. `getUserInfo` - 获取用户信息
2. `generateAvatar` - AI头像生成
3. `updatePoints` - 积分管理
4. `checkContent` - 内容安全审核

### 3.2 部署步骤（手动部署）

#### 步骤1：部署 getUserInfo
1. 在微信开发者工具左侧文件树中，找到 `cloudfunctions/getUserInfo`
2. **右键** 点击该文件夹
3. 选择 **"上传并部署：云端安装依赖"**
4. 等待部署完成（状态栏会显示进度）
5. 看到 **"部署成功"** 提示即完成

#### 步骤2：部署 generateAvatar
1. 右键 `cloudfunctions/generateAvatar`
2. 选择 **"上传并部署：云端安装依赖"**
3. 等待部署完成
4. **重要**：部署后需要在云函数配置中设置 API Key

#### 步骤3：部署 updatePoints
1. 右键 `cloudfunctions/updatePoints`
2. 选择 **"上传并部署：云端安装依赖"**
3. 等待部署完成

#### 步骤4：部署 checkContent
1. 右键 `cloudfunctions/checkContent`
2. 选择 **"上传并部署：云端安装依赖"**
3. 等待部署完成

### 3.3 云函数配置 API Key

#### 配置 DeepSeek API Key
1. 在云开发控制台 → **云函数**
2. 找到 `generateAvatar` 函数
3. 点击 **"配置"** 或 **"编辑"**
4. 在代码中找到：
```javascript
const DEEPSEEK_API_KEY = '你的DeepSeek API Key';
```
5. 替换为你的真实 API Key
6. 点击 **"保存并安装依赖"**

获取 DeepSeek API Key：
- 访问 https://platform.deepseek.com/
- 注册账号 → API Keys → 创建新 Key

### 3.4 云函数测试

在云开发控制台 → **云函数** → 选择函数 → **云端测试**：

#### 测试 getUserInfo
```json
{}
```

#### 测试 updatePoints
```json
{
  "type": "signin"
}
```

---

## 四、云存储配置

### 4.1 存储权限设置
1. 在云开发控制台 → **存储**
2. 点击 **"设置"**
3. 权限设置：**所有用户可读，仅创建者可写**

### 4.2 创建存储目录（可选）
建议创建以下目录：
- `original/` - 存放用户上传的原图
- `result/` - 存放AI生成的结果图

---

## 五、完整部署检查清单

### 部署前检查
- [ ] 已开通云开发环境
- [ ] 已获取环境ID并配置到 app.js
- [ ] 已创建3个数据库集合
- [ ] 已设置数据库权限

### 部署中检查
- [ ] getUserInfo 云函数已部署
- [ ] generateAvatar 云函数已部署
- [ ] updatePoints 云函数已部署
- [ ] checkContent 云函数已部署
- [ ] generateAvatar 已配置 API Key

### 部署后检查
- [ ] 在开发者工具中测试编译通过
- [ ] 测试首页加载正常
- [ ] 测试云函数调用正常
- [ ] 测试图片上传功能

---

## 六、常见问题

### Q1：云函数部署失败怎么办？
A：检查以下几点：
- 网络连接是否正常
- 云函数的 package.json 是否正确
- 尝试右键选择 "上传并部署：不安装依赖"，然后在云端安装

### Q2：数据库权限报错？
A：确认数据库集合权限设置为 "仅创建者可读写" 或 "所有用户可读，仅创建者可写"

### Q3：如何查看云函数日志？
A：在云开发控制台 → **云函数** → 选择函数 → **日志**

### Q4：免费版额度够吗？
A：微信云开发免费版提供：
- 数据库读/写：5万次/天
- 云函数调用：10万次/月
- 存储容量：5GB
- 对于初期测试完全足够

---

## 七、自动化部署（高级）

### 使用 CI/CD 自动化部署
1. 在微信开发者工具中配置云函数
2. 使用命令行工具上传
3. 参考微信官方文档配置

---

## 总结

按照本指南操作，你可以完成云开发环境的完整部署。如果遇到问题，优先查看云函数日志和微信官方文档。
