# AI头像生成小程序开发文档（微信小程序原生版）

## 项目概述

本项目是一个基于**微信小程序原生开发** + **微信云开发**的AI头像生成小程序。提供AI头像生成、风格选择、新疆特色素材、积分系统、广告展示等核心功能。

### 技术栈

- **前端**：微信小程序原生开发（WXML + WXSS + JavaScript）
- **后端**：微信云开发（云函数、云数据库、云存储）
- **AI接口**：
  - DeepSeek（生成提示词）
  - 百度文心一格（头像生成）

---

## 一、环境搭建指南

### 1.1 注册微信小程序

1. 访问 [微信公众平台](https://mp.weixin.qq.com/)
2. 注册/登录微信账号
3. 选择 "小程序" → "立即注册"
4. 填写小程序信息，获取 APP ID
5. 本项目 APP ID：`wxf12c2bfb15218c47`

### 1.2 开通微信云开发

1. 打开微信开发者工具，导入项目
2. 点击工具栏 "云开发" 按钮
3. 开通云开发服务（免费版即可）
4. 创建云环境，记录环境 ID

### 1.3 初始化项目

项目已经是微信小程序原生开发结构，目录如下：

```
AI avatar/
├── cloudfunctions/          # 云函数目录
├── miniprogram/             # 小程序前端代码
│   ├── pages/               # 页面
│   ├── components/          # 组件
│   ├── images/              # 静态资源（头像框、图标等）
│   ├── app.js               # 小程序入口
│   ├── app.json             # 小程序配置
│   └── app.wxss             # 全局样式
├── project.config.json      # 项目配置
└── 开发文档.md
```

### 1.4 配置云开发环境

在 `miniprogram/app.js` 中配置云环境 ID：

```javascript
App({
  onLaunch: function () {
    this.globalData = {
      env: "你的云环境ID"  // 填入你的云环境ID
    };
    if (!wx.cloud) {
      console.error("请使用 2.2.3 或以上的基础库以使用云能力");
    } else {
      wx.cloud.init({
        env: this.globalData.env,
        traceUser: true,
      });
    }
  },
});
```

---

## 二、AI API 选型与配置

### 2.1 DeepSeek API（提示词生成）

#### 模型选择
- **模型名称**：deepseek-chat
- **用途**：根据用户选择的风格生成精准的AI绘画提示词
- **价格**：
  - 输入：¥0.5/百万 tokens
  - 输出：¥2/百万 tokens

#### API 配置
在云函数中配置 DeepSeek API Key：

```javascript
const DEEPSEEK_API_KEY = "你的DeepSeek API Key";
const DEEPSEEK_API_URL = "https://api.deepseek.com/v1/chat/completions";
```

#### 获取方式
1. 访问 [DeepSeek官网](https://platform.deepseek.com/)
2. 注册/登录账号
3. 在 API Keys 页面创建新的 API Key
4. 复制 API Key 保存

### 2.2 百度文心一格 API（头像生成）

#### 模型选择
- **模型名称**：ERNIE-ViLG 4.0
- **用途**：根据提示词生成头像
- **价格**：约 ¥0.04/张

#### 配置方式
1. 访问 [百度智能云](https://cloud.baidu.com/)
2. 注册/登录账号
3. 开通文心一格服务
4. 获取 API Key 和 Secret Key

### 2.3 备选方案：硅基流动

如果预算有限，可以使用硅基流动：
- 提供多种 AI 绘画模型
- 价格实惠，适合初期测试

---

## 三、数据库设计

### 3.1 用户表（users）

| 字段名 | 数据类型 | 描述 | 默认值 |
|--------|----------|------|--------|
| _id | String | 用户 openid | 无 |
| points | Number | 用户积分 | 100 |
| totalGenerate | Number | 总生成次数 | 0 |
| dailyCheck | Object | 签到记录 | { lastDate: '', streak: 0 } |
| shareCount | Number | 今日分享次数 | 0 |
| adCount | Number | 今日广告观看次数 | 0 |
| createTime | Number | 创建时间 | Date.now() |
| updateTime | Number | 更新时间 | Date.now() |

### 3.2 图片表（images）

| 字段名 | 数据类型 | 描述 | 默认值 |
|--------|----------|------|--------|
| _id | String | 记录 ID | 无 |
| _openid | String | 用户 openid | 无 |
| originalFileID | String | 原始图片文件 ID | 无 |
| resultFileID | String | 生成结果文件 ID | 无 |
| style | String | 风格类型 | 无 |
| status | String | 生成状态 | 'success' |
| createTime | Number | 创建时间 | Date.now() |

### 3.3 积分日志表（points_log）

| 字段名 | 数据类型 | 描述 | 默认值 |
|--------|----------|------|--------|
| _id | String | 记录 ID | 无 |
| _openid | String | 用户 openid | 无 |
| type | String | 积分变动类型 | 无 |
| change | Number | 积分变动值 | 无 |
| balance | Number | 变动后余额 | 无 |
| desc | String | 变动描述 | 无 |
| createTime | Number | 创建时间 | Date.now() |

---

## 四、云函数开发

### 4.1 getUserInfo - 获取用户信息

**功能**：获取用户信息，若用户不存在则创建新用户

**文件位置**：`cloudfunctions/getUserInfo/index.js`

### 4.2 generateAvatar - AI头像生成

**功能**：核心AI头像生成函数，处理积分扣除、AI API调用、结果存储

**文件位置**：`cloudfunctions/generateAvatar/index.js`

**调用流程**：
1. 检查用户积分是否足够（每次生成消耗10积分）
2. 调用 DeepSeek 生成提示词
3. 调用文心一格生成头像
4. 保存结果到云存储
5. 记录生成历史
6. 返回结果文件ID

### 4.3 updatePoints - 积分管理

**功能**：处理用户积分变动，支持签到、观看广告、分享

**文件位置**：`cloudfunctions/updatePoints/index.js`

**积分规则**：
- 每日签到：5积分，连续签到递增（最高20积分）
- 观看广告：10积分/次
- 分享好友：5积分/次

### 4.4 checkContent - 内容安全审核

**功能**：使用微信内容安全审核API检查上传图片

**文件位置**：`cloudfunctions/checkContent/index.js`

---

## 五、前端页面开发

### 5.1 页面结构

```
pages/
├── index/           # 首页 - 风格选择 + 上传
├── result/          # 结果页 - 展示 + 保存 + 分享
├── material/        # 素材库页 - 新疆特色素材
├── gallery/         # 头像墙页 - 官方精选 + 我的作品
├── points/          # 积分中心页 - 签到 + 广告 + 分享
└── mine/            # 我的页面 - 用户信息 + 记录 + 设置
```

### 5.2 首页（index）

**功能**：
- 风格选择（8种风格）
- 拍照/相册选择
- 新疆特色素材选择
- 生成按钮

**风格类型**：
1. anime（动漫）
2. 3d（3D）
3. sketch（素描）
4. watercolor（水彩）
5. pixel（像素）
6. cartoon（卡通）
7. realistic（写实）
8. comic（漫画）

### 5.3 结果页（result）

**功能**：
- 生成结果展示
- 保存到相册
- 分享给好友
- 添加新疆特色头像框/图标
- 重新生成

### 5.4 素材库页（material）

**功能**：
- 新疆特色头像框（5个）
- 新疆各民族特色图标（10个）
- emoji 素材
- 素材预览和下载

### 5.5 头像墙（gallery）

**功能**：
- 官方精选作品展示
- 我的作品展示
- 作品点赞和分享

### 5.6 积分中心（points）

**功能**：
- 积分余额显示
- 每日签到
- 观看激励视频广告
- 分享任务
- 积分历史记录

### 5.7 我的页面（mine）

**功能**：
- 用户信息展示
- 生成历史记录
- 设置（关于我们、隐私政策、反馈建议）

---

## 六、新疆特色素材

### 6.1 已有素材

#### 头像框（5个）
- `xj_frame_1.png` - 新疆特色头像框1
- `xj_frame_2.png` - 新疆特色头像框2
- `xj_frame_3.png` - 新疆特色头像框3
- `xj_frame_4.png` - 新疆特色头像框4
- `xj_frame_5.png` - 新疆特色头像框5

#### 民族图标（10个）
- `xj_icon_1.png` ~ `xj_icon_10.png`

#### 民族图片
- `kazakh.png` - 哈萨克族
- `kirgiz.png` - 柯尔克孜族
- `mongolian.png` - 蒙古族
- `tajik.png` - 塔吉克族

### 6.2 素材获取渠道

1. **AI生成**：使用 Midjourney、Stable Diffusion 生成
2. **免费素材网站**：
   - Unsplash：https://unsplash.com/
   - Pexels：https://www.pexels.com/
   - Pixabay：https://pixabay.com/
3. **矢量图标**：
   - Iconfont：https://www.iconfont.cn/
   - Flaticon：https://www.flaticon.com/
4. **自制素材**：使用 Photoshop、Figma 设计

### 6.3 素材使用规范

- 确保素材有商用授权
- 图片格式推荐 PNG（支持透明背景）
- 头像框尺寸建议：1024x1024px
- 图标尺寸建议：256x256px

---

## 七、广告集成

### 7.1 广告类型

1. **Banner 广告**：首页底部
2. **插屏广告**：结果页
3. **激励视频广告**：积分中心（获取积分）

### 7.2 配置步骤

1. 在微信公众平台开通流量主
2. 创建广告位，获取广告位 ID
3. 在代码中集成广告组件

---

## 八、部署与发布

### 8.1 云函数部署

1. 在微信开发者工具中，右键云函数文件夹
2. 选择 "上传并部署：云端安装依赖"
3. 等待部署完成

### 8.2 小程序发布

1. 点击微信开发者工具 "上传" 按钮
2. 填写版本号和备注
3. 登录微信公众平台提交审核
4. 审核通过后点击发布

---

## 九、性能优化

### 9.1 前端优化

- 图片压缩：上传前压缩图片
- 懒加载：头像墙使用图片懒加载
- 缓存策略：缓存常用数据

### 9.2 云函数优化

- 使用索引优化数据库查询
- 完善错误处理
- 合理使用异步操作

---

## 十、安全防护

- 内容安全审核：上传图片前进行审核
- API 密钥保护：在云函数中安全存储
- 频率限制：限制每日生成次数
- 权限控制：确保用户只能访问自己的数据

---

## 十一、审核注意事项

1. 确保所有功能符合微信小程序审核规范
2. 在显著位置标注 "AI生成内容仅供参考"
3. 提供隐私政策
4. 确保内容健康，无敏感信息

---

## 十二、盈利模式

1. **广告收入**：Banner 广告、插屏广告、激励视频广告
2. **未来拓展**：付费去广告、高级风格、高清下载等

---

## 十三、版本控制

- 使用 Git 进行版本控制
- 分支管理：
  - main：正式发布
  - develop：开发分支
  - feature/*：功能分支
  - hotfix/*：修复分支

---

## 总结

本开发文档详细说明了 AI 头像生成小程序的完整开发方案，包括技术选型、数据库设计、云函数开发、前端页面、素材管理等内容。按照本文档实施，可以快速完成小程序开发并上线。
