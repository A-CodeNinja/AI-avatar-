# AI头像生成小程序 - 环境变量配置指南

## 📌 重要提示

⚠️ **安全警告**: 绝对不要将API密钥直接写在代码中！必须使用环境变量！

---

## 🔑 环境变量说明

### 云函数配置文件位置
`cloudfunctions/generateAvatar/config.json`

### 环境变量列表

| 变量名 | 说明 | 默认值 | 如何获取 |
|--------|------|--------|----------|
| `AI_API_KEY` | AI服务API密钥 | 无 | 见下方各平台获取方式 |
| `AI_API_URL` | AI服务API地址 | 豆包API地址 | 见下方各平台获取方式 |
| `AI_MODEL` | AI模型名称 | ep-20241101-xxxxx | 见下方各平台获取方式 |
| `AI_TYPE` | AI服务类型 | doubao | 可选：doubao/qianwen/zhipu/stability |

---

## 🚀 各平台API密钥获取方式

### 方案1: 豆包AI（字节跳动）⭐ 推荐

#### 获取步骤：
1. 访问：https://www.volcengine.com/
2. 注册/登录账号
3. 进入"火山方舟"控制台：https://console.volcengine.com/ark
4. 点击左侧"API密钥管理"
5. 点击"创建API密钥"
6. 复制生成的密钥

#### 配置环境变量：
```json
{
  "AI_API_KEY": "你的豆包API密钥",
  "AI_API_URL": "https://ark.cn-beijing.volces.com/api/v3/chat/completions",
  "AI_MODEL": "ep-20241101-xxxxx",  // 在"推理接入"页面查看你的模型ID
  "AI_TYPE": "doubao"
}
```

#### 免费额度：
- 新用户：1000次/月
- 价格：约0.01元/次（超出后）

---

### 方案2: 通义千问（阿里云）

#### 获取步骤：
1. 访问：https://dashscope.aliyun.com/
2. 注册/登录阿里云账号
3. 进入DashScope控制台
4. 点击左侧"API-KEY管理"
5. 点击"创建API-KEY"
6. 复制生成的密钥

#### 配置环境变量：
```json
{
  "AI_API_KEY": "你的通义千问API密钥",
  "AI_API_URL": "",
  "AI_MODEL": "wanx-v1",
  "AI_TYPE": "qianwen"
}
```

#### 免费额度：
- 新用户：2000次/月
- 价格：约0.015元/次（超出后）

---

### 方案3: 智谱AI（ChatGLM）

#### 获取步骤：
1. 访问：https://open.bigmodel.cn/
2. 注册/登录账号
3. 进入API管理页面
4. 点击"创建API Key"
5. 复制生成的密钥

#### 配置环境变量：
```json
{
  "AI_API_KEY": "你的智谱AI密钥",
  "AI_API_URL": "",
  "AI_MODEL": "cogview-3",
  "AI_TYPE": "zhipu"
}
```

#### 免费额度：
- 新用户：1500次/月
- 价格：约0.02元/次（超出后）

---

### 方案4: Stability AI（备用）

#### 获取步骤：
1. 访问：https://platform.stability.ai/
2. 注册/登录账号
3. 进入API Keys页面：https://platform.stability.ai/account/keys
4. 点击"Generate API Key"
5. 复制生成的密钥

#### 配置环境变量：
```json
{
  "AI_API_KEY": "你的Stability AI密钥",
  "AI_API_URL": "",
  "AI_MODEL": "stable-diffusion-xl-1024-v1-0",
  "AI_TYPE": "stability"
}
```

#### 价格：
- $0.02/张（约0.14元/张）
- 50元预算：约可生成350张图

---

## 🔧 如何设置环境变量

### 方法1: 使用微信开发者工具（推荐）

1. 打开微信开发者工具
2. 进入"云开发"控制台
3. 找到你的云函数 `generateAvatar`
4. 点击"配置"按钮
5. 在"环境变量"区域添加：
   - 名称：`AI_API_KEY`
   - 值：`你的API密钥`
6. 重复添加其他变量

### 方法2: 使用云函数配置文件

编辑 `cloudfunctions/generateAvatar/config.json`：

```json
{
  "envId": "cloud1-6g0jewt1e646e21b",
  "envVariables": {
    "AI_API_KEY": "你的API密钥",
    "AI_API_URL": "API地址",
    "AI_MODEL": "模型名称",
    "AI_TYPE": "doubao"
  }
}
```

编辑后需要重新上传云函数。

---

## ✅ 验证配置

配置完成后，可以测试：

1. 在小程序中上传一张图片
2. 选择风格并生成
3. 查看云函数日志：
   - 如果成功：日志会显示 "头像生成完成"
   - 如果失败：检查错误信息和环境变量配置

---

## 📊 预算建议

### 初次发布（前1000个用户）：
- 使用豆包AI免费额度：1000次
- 预算：0元

### 用户增长期（1001-5000个用户）：
- 豆包AI超出部分：4000次 × 0.01元 = 40元
- Stability AI备用：10元（约70张图）
- 预算：50元

### 用户爆发期（5000+用户）：
- 需要考虑充值积分和会员机制
- 预算根据实际情况调整

---

## ⚠️ 注意事项

1. **不要泄露API密钥**：不要将密钥提交到Git仓库
2. **定期更换密钥**：建议每3个月更换一次
3. **监控使用量**：定期检查AI API调用次数和费用
4. **设置告警**：当使用量达到免费额度90%时发送提醒

---

## 🆘 常见问题

### Q1: 如何切换AI服务商？
A: 修改 `AI_TYPE` 环境变量为 `qianwen`、`zhipu` 或 `stability`

### Q2: 如何测试不同服务商？
A: 可以准备多个环境变量配置，按需切换

### Q3: 免费额度用完了怎么办？
A: 可以切换到另一个有免费额度的服务商，或使用Stability AI备用方案

### Q4: 生成速度太慢怎么办？
A: 豆包AI通常最快（3-5秒），Stability AI较慢（10-20秒）

---

## 📞 技术支持

如果遇到问题，请检查：
1. API密钥是否正确
2. 环境变量是否正确设置
3. 云函数日志中的错误信息
4. AI服务商的控制台是否有告警
