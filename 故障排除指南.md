# AI头像生成小程序 - 故障排除指南

## 已修复的问题

### ✅ 问题1：app.json 权限配置错误
**错误信息**：`invalid app.json permission["scope.writePhotosAlbum"]`

**修复方案**：
- 已将 `permission` 改为 `requiredPrivateInfos`
- 使用正确的权限配置格式

**修复后的配置**（app.json）：
```json
"requiredPrivateInfos": [
  "chooseMedia",
  "saveImageToPhotosAlbum",
  "previewImage"
]
```

---

### ✅ 问题2：云函数调用失败
**错误信息**：`FunctionName parameter could not be found`

**原因**：云函数还没有部署到云开发环境

**解决方案**：需要先部署云函数（详见下方部署步骤）

---

## 快速开始部署步骤（5分钟）

### 第一步：配置云开发环境（1分钟）

1. **打开微信开发者工具**
   - 导入项目目录：`d:\桌面\制作各种工具性小程序赚钱\AI avatar`

2. **开通云开发**
   - 点击顶部工具栏的 **"云开发"** 按钮
   - 如果是第一次，点击 **"开通"**
   - 选择 **"免费版"**（推荐用于测试）
   - 输入环境名称，点击 **"确定"**
   - 等待1-2分钟，环境创建完成

3. **获取环境ID**
   - 在云开发控制台，点击 **"设置"** → **"环境设置"**
   - 复制 **环境ID**（格式类似：`cloud1-xxx`）

4. **配置环境ID**
   - 打开 `miniprogram/app.js`
   - 找到第4行：`env: ""`
   - 填入你的环境ID：`env: "cloud1-xxx"`
   - 保存文件

---

### 第二步：创建数据库集合（1分钟）

在云开发控制台 → **数据库**：

1. **创建 users 集合**
   - 点击 **"+"** 号
   - 集合名称输入：`users`
   - 权限设置：选择 **"仅创建者可读写"**
   - 点击 **"确定"**

2. **创建 images 集合**
   - 点击 **"+"** 号
   - 集合名称输入：`images`
   - 权限设置：选择 **"仅创建者可读写"**
   - 点击 **"确定"**

3. **创建 points_log 集合**
   - 点击 **"+"** 号
   - 集合名称输入：`points_log`
   - 权限设置：选择 **"仅创建者可读写"**
   - 点击 **"确定"**

---

### 第三步：部署云函数（3分钟）

回到微信开发者工具，在左侧文件树中找到 `cloudfunctions` 文件夹：

#### 部署 getUserInfo
1. 右键点击 `cloudfunctions/getUserInfo` 文件夹
2. 选择 **"上传并部署：云端安装依赖"**
3. 等待底部状态栏显示 **"部署成功"**

#### 部署 generateAvatar
1. 右键点击 `cloudfunctions/generateAvatar` 文件夹
2. 选择 **"上传并部署：云端安装依赖"**
3. 等待部署成功

#### 部署 updatePoints
1. 右键点击 `cloudfunctions/updatePoints` 文件夹
2. 选择 **"上传并部署：云端安装依赖"**
3. 等待部署成功

#### 部署 checkContent
1. 右键点击 `cloudfunctions/checkContent` 文件夹
2. 选择 **"上传并部署：云端安装依赖"**
3. 等待部署成功

---

### 第四步：验证部署（1分钟）

1. **在微信开发者工具中点击"编译"**
2. **查看控制台**
   - 如果看到：`云环境ID未配置，请先在 app.js 中配置 env` → 说明需要配置环境ID
   - 如果看到：`用户信息获取成功` → 说明部署成功！
3. **测试首页**
   - 点击首页的风格选择，应该可以正常切换
   - 点击上传图片，应该可以选择照片

---

## 常见问题FAQ

### Q1：云函数部署一直失败怎么办？

**A**：尝试以下方法：
1. 检查网络连接是否正常
2. 关闭微信开发者工具，重新打开
3. 右键选择 **"上传并部署：不安装依赖"**，然后在云开发控制台手动安装
4. 查看云开发控制台的云函数日志

---

### Q2：环境ID在哪里找？

**A**：
1. 点击微信开发者工具顶部的 **"云开发"** 按钮
2. 在云开发控制台，点击 **"设置"** → **"环境设置"**
3. 复制 **环境ID**（格式类似：`cloud1-xxxxx`）

---

### Q3：编译后还是报错怎么办？

**A**：
1. 确认已经配置了环境ID到 `app.js`
2. 确认已经创建了3个数据库集合
3. 确认已经部署了4个云函数
4. 点击微信开发者工具的 **"清缓存"** → **"全部清除"**
5. 重新点击 **"编译"**

---

### Q4：如何验证云函数是否部署成功？

**A**：
1. 打开云开发控制台 → **云函数**
2. 应该能看到4个云函数：
   - getUserInfo
   - generateAvatar
   - updatePoints
   - checkContent
3. 点击任意函数 → **云端测试**
4. 输入 `{}` 点击测试，看是否有返回结果

---

### Q5：DeepSeek API Key 怎么配置？

**A**：
1. 访问 https://platform.deepseek.com/ 注册账号
2. 在 API Keys 页面创建新 Key
3. 打开 `cloudfunctions/generateAvatar/index.js`
4. 找到第11行：`const DEEPSEEK_API_KEY = '你的DeepSeek API Key';`
5. 替换为你的真实 Key
6. 重新部署 generateAvatar 云函数

---

## 部署检查清单

在开始测试前，请确认：

- [ ] 已开通云开发环境
- [ ] 已获取环境ID并配置到 app.js
- [ ] 已创建 3 个数据库集合（users、images、points_log）
- [ ] 已部署 4 个云函数
- [ ] 在开发者工具中点击"编译"没有报错

---

## 成功标志

当你看到以下情况时，说明部署成功：

✅ 控制台没有红色错误  
✅ 首页可以正常显示  
✅ 风格选择可以正常切换  
✅ 点击上传可以选择图片

---

## 下一步

部署成功后，你可以：
1. 测试各项功能
2. 按照 **云开发部署指南.md** 进行更多配置
3. 接入真实的 AI API
4. 开始优化和测试

祝开发顺利！🎉
